<!DOCTYPE html>
<html lang="en">
  <head>
    <title>OAuth2  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="OAuth2  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">OAuth2 Docs</a> (70% documented)</p>
        <p class="header-right"><a href="http://p2.github.io/OAuth2"><img src="img/gh.png"/>View on GitHub</a></p>
        <p class="header-right"><a href="dash-feed://http%3A%2F%2Fsmart%2Don%2Dfhir%2Egithub%2Eio%2Fdocsets%2FOAuth2%2Exml"><img src="img/dash.png"/>Install in Dash</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">OAuth2 Reference</a>
        <img id="carat" src="img/carat.png" />
        OAuth2  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ArchiveKey.html">ArchiveKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/BaseKey.html">BaseKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GenericKey.html">GenericKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Keychain.html">Keychain</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/KeychainQuery.html">KeychainQuery</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2.html">OAuth2</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2Base.html">OAuth2Base</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2ClientConfig.html">OAuth2ClientConfig</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2ClientCredentials.html">OAuth2ClientCredentials</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2CodeGrant.html">OAuth2CodeGrant</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2CodeGrantBasicAuth.html">OAuth2CodeGrantBasicAuth</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes.html#/s:C6OAuth223OAuth2CodeGrantFacebook">OAuth2CodeGrantFacebook</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2CodeGrantLinkedIn.html">OAuth2CodeGrantLinkedIn</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2CodeGrantNoTokenType.html">OAuth2CodeGrantNoTokenType</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2DebugURLSessionDelegate.html">OAuth2DebugURLSessionDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2DynReg.html">OAuth2DynReg</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2ImplicitGrant.html">OAuth2ImplicitGrant</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2PasswordGrant.html">OAuth2PasswordGrant</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes.html#/s:C6OAuth213OAuth2Request">OAuth2Request</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OAuth2WebViewController.html">OAuth2WebViewController</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/OAuth2EndpointAuthMethod.html">OAuth2EndpointAuthMethod</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/OAuth2Error.html">OAuth2Error</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/NSHTTPURLResponse.html">NSHTTPURLResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSURLRequest.html">NSURLRequest</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Functions.html#/s:ZF6OAuth2oi2eeFTOS_11OAuth2ErrorS0__Sb">==(_:_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/KeychainItem.html">KeychainItem</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/KeychainService.html">KeychainService</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/OAuth2AuthConfig.html">OAuth2AuthConfig</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Typealiases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:6OAuth210OAuth2JSON">OAuth2JSON</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:6OAuth216OAuth2StringDict">OAuth2StringDict</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <a href='#oauth2' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='oauth2'>OAuth2</h1>

<p><a href="https://travis-ci.org/p2/OAuth2"><img src="https://travis-ci.org/p2/OAuth2.svg?branch=master" alt="Build Status"></a>
<a href="LICENSE.txt"><img src="https://img.shields.io/:license-apache-blue.svg" alt="License"></a></p>

<p>OAuth2 frameworks for <strong>OS X</strong> and <strong>iOS</strong> written in Swift 2.0.</p>

<p>Technical documentation is available at <a href="https://p2.github.io/OAuth2">p2.github.io/OAuth2</a>.
Take a look at the <a href="https://github.com/p2/OAuth2App">OS X sample app</a> for basic usage of this framework.</p>

<p>The code in this repo requires Xcode 7, the built framework can be used on <strong>OS X 10.9</strong> or <strong>iOS 8</strong> and later.
To use on <strong>iOS 7</strong> you&rsquo;ll have to include the source files in your main project.</p>
<a href='#swift_version' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='swift_version'>Swift Version</h4>

<p>Since the Swift language is constantly evolving I have adopted a versioning scheme mirroring Swift versions:
the framework version&rsquo;s <strong>first two digits are always the Swift version</strong> the library is compatible with, see <a href="https://github.com/p2/OAuth2/releases">releases</a>.
Code compatible with brand new Swift versions are to be found on a separate feature branch named after their swift version.</p>
<a href='#usage' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='usage'>Usage</h2>

<p>To use OAuth2 in your own code, start with <code>import OAuth2</code> (use <code>p2_OAuth2</code> if you installed <em>p2.OAuth2</em> via CocoaPods) in your source files.</p>

<p>For a typical code grant flow you want to perform the following steps.
The steps for other flows are mostly the same short of instantiating a different subclass and using different client settings.
If you need to provide additional parameters to the authorize URL take a look at <code>authorizeURLWithRedirect(redirect:scope:params:)</code>.</p>
<a href='#1_create_a_settings_dictionary' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='1_create_a_settings_dictionary'>1. Create a Settings Dictionary.</h3>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">settings</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"client_id"</span><span class="p">:</span> <span class="s">"my_swift_app"</span><span class="p">,</span>
    <span class="s">"client_secret"</span><span class="p">:</span> <span class="s">"C7447242-A0CF-47C5-BAC7-B38BA91970A9"</span><span class="p">,</span>
    <span class="s">"authorize_uri"</span><span class="p">:</span> <span class="s">"https://authorize.smarthealthit.org/authorize"</span><span class="p">,</span>
    <span class="s">"token_uri"</span><span class="p">:</span> <span class="s">"https://authorize.smarthealthit.org/token"</span><span class="p">,</span>   <span class="c1">// code grant only!</span>
    <span class="s">"scope"</span><span class="p">:</span> <span class="s">"profile email"</span><span class="p">,</span>
    <span class="s">"redirect_uris"</span><span class="p">:</span> <span class="p">[</span><span class="s">"myapp://oauth/callback"</span><span class="p">],</span>   <span class="c1">// don't forget to register this scheme</span>
    <span class="s">"keychain"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>     <span class="c1">// if you DON'T want keychain integration</span>
    <span class="s">"title"</span><span class="p">:</span> <span class="s">"My Service"</span>  <span class="c1">// optional title to show in views</span>
<span class="p">]</span> <span class="k">as</span> <span class="kt">OAuth2JSON</span>            <span class="c1">// the "as" part may or may not be needed</span>
</code></pre>
<a href='#2_instantiate_oauth2' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='2_instantiate_oauth2'>2. Instantiate OAuth2</h3>

<p>Create an <code>OAuth2CodeGrant</code> Instance.
Optionally, set the <code>onAuthorize</code> and <code>onFailure</code> closures <strong>or</strong> the <code>afterAuthorizeOrFailure</code> closure to keep informed about the status.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">oauth2</span> <span class="o">=</span> <span class="kt">OAuth2CodeGrant</span><span class="p">(</span><span class="nv">settings</span><span class="p">:</span> <span class="n">settings</span><span class="p">)</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">onAuthorize</span> <span class="o">=</span> <span class="p">{</span> <span class="n">parameters</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Did authorize with parameters: </span><span class="se">\(</span><span class="n">parameters</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">onFailure</span> <span class="o">=</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>        <span class="c1">// `error` is nil on cancel</span>
    <span class="k">if</span> <span class="kc">nil</span> <span class="o">!=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Authorization went wrong: </span><span class="se">\(</span><span class="n">error</span><span class="o">!.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<a href='#3_authorize_the_user' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='3_authorize_the_user'>3. Authorize the User</h3>

<p>By default the OS browser will be used for authorization if there is no access token present in the keychain.
To start authorization call <strong><code>authorize()</code></strong> or the convenience method <code>authorizeEmbeddedFrom(&lt;# UIViewController or NSWindow #&gt;)</code>.</p>

<p>The latter configures <code>authConfig</code> like so: changes <code>authorizeEmbedded</code> to <code>true</code> and sets a root view controller/window, from which to present the login screen, as <code>authorizeContext</code>.
See <a href="#advanced-settings"><em>Advanced Settings</em></a> for other options.</p>

<p><strong>Starting with iOS 9</strong>, <code>SFSafariViewController</code> will be used when enabling embedded authorization.</p>

<p>Your <code>oauth2</code> instance will use <code>NSURLSession.defaultSession()</code> for requests, exposed on <code>oauth2.session</code>.
You can set <code>oauth2.sessionConfiguration</code> if you wish to change things like timeout values, and you can set <code>oauth2.sessionDelegate</code> to your own session delegate if you like.</p>
<pre class="highlight swift"><code><span class="n">oauth2</span><span class="o">.</span><span class="n">authConfig</span><span class="o">.</span><span class="n">authorizeEmbedded</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">authConfig</span><span class="o">.</span><span class="n">authorizeContext</span> <span class="o">=</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">presenting</span> <span class="n">view</span> <span class="n">controller</span> <span class="o">/</span> <span class="n">window</span> <span class="err">#</span><span class="o">&gt;</span>
<span class="n">oauth2</span><span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>

<span class="c1">// for embedded authorization you can just use:</span>
<span class="n">oauth2</span><span class="o">.</span><span class="nf">authorizeEmbeddedFrom</span><span class="p">(</span><span class="o">&lt;</span><span class="err">#</span> <span class="n">presenting</span> <span class="n">view</span> <span class="n">controller</span> <span class="o">/</span> <span class="n">window</span> <span class="err">#</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre>

<p>When using the OS browser or the iOS 9 Safari view controller, you will need to <strong>intercept the callback</strong> in your app delegate.
Let the OAuth2 instance handle the full URL:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span>
                 <span class="n">openURL</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">NSURL</span><span class="p">,</span>
           <span class="nv">sourceApplication</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span>
                  <span class="nv">annotation</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="c1">// you should probably first check if this is your URL being opened</span>
    <span class="k">if</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">check</span> <span class="err">#</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">oauth2</span><span class="o">.</span><span class="nf">handleRedirectURL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>See <a href="#manually-performing-authentication"><em>Manually Performing Authentication</em></a> below for details on how to do this on the Mac.</p>
<a href='#4_receive_callback' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='4_receive_callback'>4. Receive Callback</h3>

<p>After everything completes either the <code>onAuthorize</code> or the <code>onFailure</code> closure will be called, and after that the <code>afterAuthorizeOrFailure</code> closure if it has been set.
Hence, unless you have a reason to, you don&rsquo;t need to set all three callbacks, you can use any of those.</p>
<a href='#5_make_requests' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='5_make_requests'>5. Make Requests</h3>

<p>You can now obtain an <code>OAuth2Request</code>, which is an already signed <code>NSMutableURLRequest</code>, to retrieve data from your server.
If you use <em>Alamofire</em> there&rsquo;s a <a href="#usage-with-alamofire">class extension</a> below that you can use.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">req</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="nv">forURL</span><span class="p">:</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">resource</span> <span class="kt">URL</span> <span class="err">#</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="nf">dataTaskWithRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="c1">// something went wrong, check the error</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// check the response and the data</span>
        <span class="c1">// you have just received data with an OAuth2-signed request!</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
</code></pre>

<p>Of course you can use your own <code>NSURLSession</code> with these requests, you don&rsquo;t have to use <code>oauth2.session</code>.</p>
<a href='#6_cancel_authorization' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='6_cancel_authorization'>6. Cancel Authorization</h3>

<p>You can cancel an ongoing authorization any time by calling <code>oauth2.abortAuthorization()</code>.
This will cancel ongoing requests (like a code exchange request) or call the callback while you&rsquo;re waiting for a user to login on a webpage.
The latter will dismiss embedded login screens or redirect the user back to the app.</p>
<a href='#7_re_authorize' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='7_re_authorize'>7. Re-Authorize</h3>

<p>It is safe to always call <code>oauth2.authorize()</code> before performing a request.
You can also perform the authorization before the first request after your app became active again.
Or you can always intercept 401s in your requests and call authorize again before re-attempting the request.</p>
<a href='#8_logout' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='8_logout'>8. Logout</h3>

<p>If you&rsquo;re storing tokens to the keychain, you can call <code>forgetTokens()</code> to throw them away.</p>

<p><strong>However</strong> your user is likely still logged in to the website, so on the next <code>authorize()</code> call, the web view may appear and immediately disappear.
When using the built-in web view on iOS 8, one can use the following snippet to throw away any cookies the app created.
With the newer <code>SFSafariViewController</code>, or logins performed in the browser, it&rsquo;s probably best to directly <strong>open the logout page</strong> so the user sees the logout happen.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span> <span class="kt">NSHTTPCookieStorage</span><span class="o">.</span><span class="nf">sharedHTTPCookieStorage</span><span class="p">()</span>
<span class="n">storage</span><span class="o">.</span><span class="n">cookies</span><span class="p">?</span><span class="o">.</span><span class="nf">forEach</span><span class="p">()</span> <span class="p">{</span> <span class="n">storage</span><span class="o">.</span><span class="nf">deleteCookie</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
<a href='#manually_performing_authentication' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='manually_performing_authentication'>Manually Performing Authentication</h2>

<p>The <code>authorize()</code> method will:</p>

<ol>
<li>Check if an access token that has not yet expired is in the keychain, if not</li>
<li>Check if a refresh token is in the keychain, if found</li>
<li>Try to use the refresh token to get a new access token, if it fails</li>
<li>Start the OAuth2 dance by using the <code>authConfig</code> settings to determine how to display an authorize screen to the user</li>
</ol>

<p>If you do <strong>not wish this kind of automation</strong>, the manual steps to show the authorize screens are:</p>

<p><strong>Embedded iOS</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">vc</span> <span class="o">=</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">presenting</span> <span class="n">view</span> <span class="n">controller</span> <span class="err">#</span><span class="o">&gt;</span>
<span class="k">let</span> <span class="nv">web</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="nf">authorizeEmbeddedFrom</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">afterAuthorizeOrFailure</span> <span class="o">=</span> <span class="p">{</span> <span class="n">wasFailure</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="n">web</span><span class="o">.</span><span class="nf">dismissViewControllerAnimated</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p><strong>Modal Sheet on OS X</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">win</span> <span class="o">=</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">window</span> <span class="n">to</span> <span class="n">present</span> <span class="n">from</span> <span class="err">#</span><span class="o">&gt;</span>
<span class="c1">// if `win` is nil, will open a new window</span>
<span class="n">oauth2</span><span class="o">.</span><span class="nf">authorizeEmbeddedFrom</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
</code></pre>

<p><strong>Present yourself on OS X</strong>:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">vc</span> <span class="o">=</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">view</span> <span class="n">controller</span> <span class="err">#</span><span class="o">&gt;</span>
<span class="k">let</span> <span class="nv">web</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="nf">presentableAuthorizeViewController</span><span class="p">()</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">afterAuthorizeOrFailure</span> <span class="o">=</span> <span class="p">{</span> <span class="n">wasFailure</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="n">vc</span><span class="o">.</span><span class="nf">dismissViewController</span><span class="p">(</span><span class="n">web</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">vc</span><span class="o">.</span><span class="nf">presentViewController</span><span class="p">(</span><span class="n">web</span><span class="p">,</span> <span class="nv">animator</span><span class="p">:</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">animator</span> <span class="err">#</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre>

<p><strong>iOS/OS X browser</strong>:</p>
<pre class="highlight swift"><code><span class="k">try!</span> <span class="n">oauth2</span><span class="o">.</span><span class="nf">openAuthorizeURLInBrowser</span><span class="p">()</span>
</code></pre>

<p>In case you&rsquo;re using the OS browser or the new Safari view controller, you will need to <strong>intercept the callback</strong> in your app delegate.</p>

<p><strong>iOS</strong></p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="o">!</span><span class="p">,</span>
                 <span class="n">openURL</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">NSURL</span><span class="o">!</span><span class="p">,</span>
           <span class="nv">sourceApplication</span><span class="p">:</span> <span class="kt">String</span><span class="o">!</span><span class="p">,</span>
                  <span class="nv">annotation</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="o">!</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="c1">// you should probably first check if this is your URL being opened</span>
    <span class="k">if</span> <span class="o">&lt;</span><span class="err">#</span> <span class="n">check</span> <span class="err">#</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">oauth2</span><span class="o">.</span><span class="nf">handleRedirectURL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><strong>OS X</strong></p>

<p>See the <a href="https://github.com/p2/OAuth2App">OAuth2 Sample App</a>&rsquo;s AppDelegate class on how to receive the callback URL in your Mac app.
If the authentication displays the code to the user, e.g. with Google&rsquo;s <code>urn:ietf:wg:oauth:2.0:oob</code> callback URL, you can retrieve the code from the user&rsquo;s pasteboard and continue authorization with:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">pboard</span> <span class="o">=</span> <span class="kt">NSPasteboard</span><span class="o">.</span><span class="nf">generalPasteboard</span><span class="p">()</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">pasted</span> <span class="o">=</span> <span class="n">pboard</span><span class="o">.</span><span class="nf">stringForType</span><span class="p">(</span><span class="kt">NSPasteboardTypeString</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">oauth2</span><span class="o">.</span><span class="nf">exchangeCodeForToken</span><span class="p">(</span><span class="n">pasted</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<a href='#flows' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='flows'>Flows</h2>

<p>Based on which OAuth2 flow that you need you will want to use the correct subclass.
For a very nice explanation of OAuth&rsquo;s basics: <a href="http://oauthbible.com/#oauth-2-three-legged">The OAuth Bible</a>.</p>
<a href='#code_grant' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='code_grant'>Code Grant</h4>

<p>For a full OAuth 2 code grant flow (<code>response_type=code</code>) you want to use the <code>OAuth2CodeGrant</code> class.
This flow is typically used by applications that can guard their secrets, like server-side apps, and not in distributed binaries.
In case an application cannot guard its secret, such as a distributed iOS app, you would use the <em>implicit grant</em> or, in some cases, still a <em>code grant</em> but omitting the client secret.
It has however become common practice to still use code grants from mobile devices, including a client secret.
This class fully supports those flows, it automatically creates a “Basic” Authorization header if the client has a client secret.
If the site requires client credentials in the request body, set <code>secretInBody</code> to true, as explained below.</p>
<a href='#implicit_grant' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='implicit_grant'>Implicit Grant</h4>

<p>An implicit grant (<code>response_type=token</code>) is suitable for apps that are not capable of guarding their secret, such as distributed binaries or client-side web apps.
Use the <code>OAuth2ImplicitGrant</code> class to receive a token and perform requests.</p>

<p>Would be nice to add another code example here, but it&rsquo;s pretty much the same as for the <em>code grant</em>.</p>
<a href='#client_credentials' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='client_credentials'>Client Credentials</h4>

<p>A 2-legged flow that lets an app authenticate itself via its client id and secret.
Instantiate <code>OAuth2ClientCredentials</code>, as usual supplying <code>client_id</code> but also a <code>client_secret</code> – plus your other configurations – in the settings dict, and you should be good to go.</p>
<a href='#username_and_password' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='username_and_password'>Username and Password</h4>

<p>The <em>Resource Owner Password Credentials Grant</em> is supported with the <code>OAuth2PasswordGrant</code> subclass.
Create an instance as shown above, set its <code>username</code> and <code>password</code> properties, then call <code>authorize()</code>.</p>
<a href='#site_specific_peculiarities' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='site_specific_peculiarities'>Site-Specific Peculiarities</h3>

<p>Some sites might not strictly adhere to the OAuth2 flow.
The framework deals with those deviations by creating site-specific subclasses.</p>
<a href='#facebook' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='facebook'>Facebook</h4>

<p>Use <code>OAuth2CodeGrantFacebook</code> to deal with the <a href="https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow/v2.2">URL-query-style response</a> instead of the expected JSON dictionary.</p>
<a href='#github' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='github'>GitHub</h4>

<p><code>OAuth2CodeGrant</code> automatically puts the client-key/client-secret into an “Authorization: Basic” header.
GitHub however needs those two in the POSTed body; you need to set the <code>authConfig.secretInBody</code> setting to true, either directly in code or via the <code>secret_in_body</code> key in the settings dictionary.</p>
<a href='#reddit' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='reddit'>Reddit</h4>

<p><code>OAuth2CodeGrant</code> automatically adds a <em>Basic</em> authorization header when a client secret is set.
This means that you <strong>must</strong> specify a client_secret; if there is none (like for <a href="https://github.com/reddit/reddit/wiki/OAuth2#token-retrieval-code-flow">Reddit</a>) specify the empty string.
There is a <a href="https://github.com/p2/OAuth2App/blob/master/OAuth2App/RedditLoader.swift">RedditLoader</a> example in the <a href="https://github.com/p2/OAuth2App">OAuth2App sample app</a> for a basic usage example.</p>
<a href='#google' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='google'>Google</h4>

<p>If you authorize against Google with a <code>OAuth2CodeGrant</code>, the built-in iOS web view will intercept the <code>http://localhost</code> as well as the <code>urn:ietf:wg:oauth:2.0:oob</code> (with or without <code>:auto</code>) callbacks.
This means you must disable the Safari view controller and – for now – this only works on iOS.</p>
<pre class="highlight swift"><code><span class="n">oauth2</span><span class="o">.</span><span class="n">authConfig</span><span class="o">.</span><span class="n">authorizeEmbedded</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">oauth2</span><span class="o">.</span><span class="n">authConfig</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">useSafariView</span> <span class="o">=</span> <span class="kc">false</span>
</code></pre>
<a href='#linkedin' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='linkedin'>LinkedIn</h4>

<p>There are a couple of peculiarities with LinkedIn&rsquo;s OAuth2 implementation.
You can use <code>OAuth2CodeGrantLinkedIn</code> which deals with those, but since it needs the custom embedded web view this will only work on iOS for now.
To receive <em>JSON</em> you will also need to use their special header <code>x-li-format</code> and set it to <code>json</code>:</p>
<pre class="highlight swift"><code><span class="n">urlRequest</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="s">"json"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"x-li-format"</span><span class="p">)</span>
</code></pre>
<a href='#instagram_bitly' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='instagram_bitly'>Instagram, Bitly, &hellip;</h4>

<p>Some sites don&rsquo;t return the required <code>token_type</code> parameter in their token response.
LinkedIn does the same, see above.
You can tell if you&rsquo;re getting the error <em>“No token type received, will not use the token”</em>.
There is a subclass for code grant flows that ignores the missing token type that you can use: <a href="Sources/Base/OAuth2CodeGrantNoTokenType.swift"><code>OAuth2CodeGrantNoTokenType</code></a>.</p>

<p>For <em>Instagram</em> you also need to set <code>oauth2.authConfig.secretInBody = true</code> (or use <code>secret_in_body</code> in your settings dict) because it expects the client secret in the request body, not the <em>Authorization</em> header.</p>
<a href='#usage_with_alamofire' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='usage_with_alamofire'>Usage with Alamofire</h2>

<p>Here&rsquo;s an extension that can be used with Alamofire:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Alamofire</span>

<span class="kd">extension</span> <span class="kt">OAuth2</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span>
        <span class="nv">method</span><span class="p">:</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="kt">Method</span><span class="p">,</span>
        <span class="n">_</span> <span class="kt">URLString</span><span class="p">:</span> <span class="kt">URLStringConvertible</span><span class="p">,</span>
        <span class="nv">parameters</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="nv">encoding</span><span class="p">:</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="kt">ParameterEncoding</span> <span class="o">=</span> <span class="o">.</span><span class="kt">URL</span><span class="p">,</span>
        <span class="nv">headers</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="o">-&gt;</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="kt">Request</span>
    <span class="p">{</span>

        <span class="k">var</span> <span class="nv">hdrs</span> <span class="o">=</span> <span class="n">headers</span> <span class="p">??</span> <span class="p">[:]</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">token</span> <span class="o">=</span> <span class="n">accessToken</span> <span class="p">{</span>
            <span class="n">hdrs</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Bearer </span><span class="se">\(</span><span class="n">token</span><span class="se">)</span><span class="s">"</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="kt">URLString</span><span class="p">,</span>
            <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="nv">encoding</span><span class="p">:</span> <span class="n">encoding</span><span class="p">,</span>
            <span class="nv">headers</span><span class="p">:</span> <span class="n">hdrs</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>You can now use the handle to your <code>OAuth2</code> instance instead of using <em>Alamofire</em> directly to make requests that are signed.
Of course this will only work once you have an access token.
You can use <code>hasUnexpiredAccessToken()</code> to check for one or just always call <code>authorize()</code> first; it will call your callback immediately if you have a token.</p>
<pre class="highlight swift"><code><span class="n">oauth2</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="s">"http://httpbin.org/get"</span><span class="p">)</span>
</code></pre>
<a href='#dynamic_client_registration' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='dynamic_client_registration'>Dynamic Client Registration</h2>

<p>There is support for <a href="https://tools.ietf.org/html/rfc7591">dynamic client registration</a>.
If during setup <code>registration_url</code> is set but <code>client_id</code> is not, the <code>authorize()</code> call automatically attempts to register the client before continuing to the actual authorization.
Client credentials returned from registration are stored to the keychain.</p>

<p>The <code>OAuth2DynReg</code> class is responsible for handling client registration.
You can use its <code>registerClient(client:callback:)</code> method manually if you need to.
Registration parameters are taken from the client&rsquo;s configuration.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">oauth2</span> <span class="o">=</span> <span class="kt">OAuth2</span><span class="o">...</span><span class="p">()</span>
<span class="n">oauth2</span><span class="o">.</span><span class="nf">registerClientIfNeeded</span><span class="p">()</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="c1">// registration failed</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// client was registered</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">oauth2</span> <span class="o">=</span> <span class="kt">OAuth2</span><span class="o">...</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">dynreg</span> <span class="o">=</span> <span class="kt">OAuth2DynReg</span><span class="p">()</span>
<span class="n">dynreg</span><span class="o">.</span><span class="nf">registerClient</span><span class="p">(</span><span class="n">oauth2</span><span class="p">)</span> <span class="p">{</span> <span class="n">params</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="c1">// registration failed</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// client was registered with `params`</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<a href='#keychain' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='keychain'>Keychain</h2>

<p>This framework can transparently use the iOS and OS X keychain.
It is controlled by the <code>useKeychain</code> property, which can be disabled during initialization with the <q>keychain</q> setting.
Since this is <strong>enabled by default</strong>, if you do <em>not</em> turn it off during initialization, the keychain will be queried for tokens and client credentials related to the authorization URL.
If you turn it off <em>after</em> initialization, the keychain will be queried for existing tokens, but new tokens will not be written to the keychain.</p>

<p>If you want to delete the tokens from keychain, i.e. <strong>log the user out</strong> completely, call <code>forgetTokens()</code>.
If you have dynamically registered your client and want to start anew, you can call <code>forgetClient()</code>.</p>

<p>Ideally, access tokens get delivered with an <q>expires_in</q> parameter that tells you how long the token is valid.
If it is missing the framework will still use those tokens if one is found in the keychain and not re-perform the OAuth dance.
You will need to intercept 401s and re-authenticate if an access token has expired but the framework has still pulled it from the keychain.
This behavior can be turned off by supplying <q>token_assume_unexpired</q>: false in settings or setting <code>clientConfig.accessTokenAssumeUnexpired</code> to false.</p>
<a href='#advanced_settings' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='advanced_settings'>Advanced Settings</h2>

<p>The main configuration you&rsquo;ll use with <code>oauth2.authConfig</code> is whether or not to use an embedded login:</p>
<pre class="highlight plaintext"><code>oauth2.authConfig.authorizeEmbedded = true
</code></pre>

<p>Starting with version 2.0.1 on iOS 9, <code>SFSafariViewController</code> will be used for embedded authorization.
To revert to the old custom <code>OAuth2WebViewController</code>:</p>
<pre class="highlight plaintext"><code>oauth2.authConfig.ui.useSafariView = false
</code></pre>

<p>To customize the <em>go back</em> button when using <code>OAuth2WebViewController</code>:</p>
<pre class="highlight plaintext"><code>oauth2.authConfig.ui.backButton = &lt;# UIBarButtonItem(...) #&gt;
</code></pre>

<p>Some sites also want the client-id/secret combination in the request <em>body</em>, not in the <em>Authorization</em> header:</p>
<pre class="highlight plaintext"><code>oauth2.authConfig.secretInBody = true
</code></pre>
<a href='#installation' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='installation'>Installation</h2>

<p>You can use git or CocoaPods to install the framework.</p>
<a href='#cocoapods' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='cocoapods'>CocoaPods</h4>

<p>Add a <code>Podfile</code> that contains at least the following information to the root of your app project, then do <code>pod install</code>.
If you&rsquo;re unfamiliar with CocoaPods, read <a href="http://guides.cocoapods.org/using/using-cocoapods.html">using CocoaPods</a>.</p>
<pre class="highlight ruby"><code><span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'8.0'</span>      <span class="c1"># or platform :osx, '10.9'</span>
<span class="n">pod</span> <span class="s1">'p2.OAuth2'</span>
<span class="n">use_frameworks!</span>
</code></pre>
<a href='#git' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='git'>git</h4>

<p>Using Terminal.app, clone the OAuth2 repository, best into a subdirectory of your app project:  </p>
<pre class="highlight plaintext"><code>$ cd path/to/your/app
$ git clone --recursive https://github.com/p2/OAuth2.git
</code></pre>

<p>If you&rsquo;re using git you&rsquo;ll want to add it as a submodule.
Once cloning completes, open your app project in Xcode and add <code>OAuth2.xcodeproj</code> to your app:</p>

<p><img src="assets/step-adding.png" alt="Adding to Xcode"></p>

<p>Now link the framework to your app:</p>

<p><img src="assets/step-linking.png" alt="Linking"></p>

<p>These three steps are needed to:</p>

<ol>
<li>Make your App also build the framework</li>
<li>Link the framework into your app</li>
<li>Embed the framework in your app when distributing</li>
</ol>

<blockquote>
<p>NOTE that as of Xcode 6.2, the <q>embed</q> step happens in the <q>General</q> tab.
You may want to perform step 2 and 3 from the <q>General</q> tab.
Also make sure you select the framework for the platform, as of Xcode 7 this is visible behind <em>OAuth2.framework</em>.</p>
</blockquote>
<a href='#license' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='license'>License</h2>

<p>This code is released under the <a href="LICENSE.txt"><em>Apache 2.0 license</em></a>, which means that you can use it in open as well as closed source projects.
Since there is no <code>NOTICE</code> file there is nothing that you have to include in your product.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2016 <a class="link" href="http://www.github.com/p2" target="_blank" rel="external">Pascal Pfiffner</a>. All rights reserved. (Last updated: 2016-02-09)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.5.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
